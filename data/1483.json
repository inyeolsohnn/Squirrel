{
  "id": 1483,
  "url": "www.dofactory.com/topic/1483/patterns-in-action-and-logging-in.aspx",
  "title": "Patterns In Action throws exception when logging in",
  "ques": "Hi: \r\nI just downloaded the framework (.NET 4.0) and started the \u0027Patterns In Action\u0027 project.  Regardless of which presentation layer I use it throws an exception when I try to do the Login required by the program.  It crashes in file \u0027ActionService.cs\u0027 in method \u0027Login\u0027, line 81:\r\nif (!Membership.ValidateUser(request.UserName, request.Password))\r\nThe exception is:\r\nSystem.Data.SqlClient.SqlException was unhandled by user code\r\n  Message\u003dThe database \u0027C:MARKSSTUFFMARSDOFACTORYPATTERNS IN ACTIONHOST.WCF.ACTIONSERVERAPP_DATAASPNETDB.MDF\u0027 cannot be opened because it is version 655. This server supports version 611 and earlier. A downgrade path is not supported.\r\nCould not open new database \u0027C:MARKSSTUFFMARSDOFACTORYPATTERNS IN ACTIONHOST.WCF.ACTIONSERVERAPP_DATAASPNETDB.MDF\u0027. CREATE DATABASE is aborted.\r\nAn attempt to attach an auto-named database for file C:MarksStuffMarsDoFactoryPatterns In ActionHost.WCF.ActionServerApp_Dataaspnetdb.mdf failed. A database with the same name exists, or specified file cannot be opened, or it is located on UNC share.\r\n  Source\u003d.Net SqlClient Data Provider\r\n  ErrorCode\u003d-2146232060\r\n  Class\u003d20\r\n  LineNumber\u003d65536\r\n  Number\u003d948\r\n  Procedure\u003d\u0027\u0027\r\n  Server\u003d\\.pipe4C1D8742-0D2B-48tsqlquery\r\n  State\u003d1\r\n  StackTrace:\r\n       at System.Data.SqlClient.SqlInternalConnection.OnError(SqlException exception, Boolean breakConnection)\r\n       at System.Data.SqlClient.TdsParser.ThrowExceptionAndWarning()\r\n       at System.Data.SqlClient.TdsParser.Run(RunBehavior runBehavior, SqlCommand cmdHandler, SqlDataReader dataStream, BulkCopySimpleResultSet bulkCopyHandler, TdsParserStateObject stateObj)\r\n       at System.Data.SqlClient.SqlInternalConnectionTds.CompleteLogin(Boolean enlistOK)\r\n       at System.Data.SqlClient.SqlInternalConnectionTds.AttemptOneLogin(ServerInfo serverInfo, String newPassword, Boolean ignoreSniOpenTimeout, TimeoutTimer timeout, SqlConnection owningObject)\r\n       at System.Data.SqlClient.SqlInternalConnectionTds.LoginNoFailover(ServerInfo serverInfo, String newPassword, Boolean redirectedUserInstance, SqlConnection owningObject, SqlConnectionString connectionOptions, TimeoutTimer timeout)\r\n       at System.Data.SqlClient.SqlInternalConnectionTds.OpenLoginEnlist(SqlConnection owningObject, TimeoutTimer timeout, SqlConnectionString connectionOptions, String newPassword, Boolean redirectedUserInstance)\r\n       at System.Data.SqlClient.SqlInternalConnectionTds..ctor(DbConnectionPoolIdentity identity, SqlConnectionString connectionOptions, Object providerInfo, String newPassword, SqlConnection owningObject, Boolean redirectedUserInstance)\r\n       at System.Data.SqlClient.SqlConnectionFactory.CreateConnection(DbConnectionOptions options, Object poolGroupProviderInfo, DbConnectionPool pool, DbConnection owningConnection)\r\n       at System.Data.ProviderBase.DbConnectionFactory.CreatePooledConnection(DbConnection owningConnection, DbConnectionPool pool, DbConnectionOptions options)\r\n       at System.Data.ProviderBase.DbConnectionPool.CreateObject(DbConnection owningObject)\r\n       at System.Data.ProviderBase.DbConnectionPool.UserCreateRequest(DbConnection owningObject)\r\n       at System.Data.ProviderBase.DbConnectionPool.GetConnection(DbConnection owningObject)\r\n       at System.Data.ProviderBase.DbConnectionFactory.GetConnection(DbConnection owningConnection)\r\n       at System.Data.ProviderBase.DbConnectionClosed.OpenConnection(DbConnection outerConnection, DbConnectionFactory connectionFactory)\r\n       at System.Data.SqlClient.SqlConnection.Open()\r\n       at System.Web.DataAccess.SqlConnectionHolder.Open(HttpContext context, Boolean revertImpersonate)\r\n       at System.Web.DataAccess.SqlConnectionHelper.GetConnection(String connectionString, Boolean revertImpersonation)\r\n       at System.Web.Security.SqlMembershipProvider.GetPasswordWithFormat(String username, Boolean updateLastLoginActivityDate, Int32\u0026 status, String\u0026 password, Int32\u0026 passwordFormat, String\u0026 passwordSalt, Int32\u0026 failedPasswordAttemptCount, Int32\u0026 failedPasswordAnswerAttemptCount, Boolean\u0026 isApproved, DateTime\u0026 lastLoginDate, DateTime\u0026 lastActivityDate)\r\n       at System.Web.Security.SqlMembershipProvider.CheckPassword(String username, String password, Boolean updateLastLoginActivityDate, Boolean failIfNotApproved, String\u0026 salt, Int32\u0026 passwordFormat)\r\n       at System.Web.Security.SqlMembershipProvider.ValidateUser(String username, String password)\r\n       at System.Web.Security.Membership.ValidateUser(String username, String password)\r\n       at ActionService.ServiceImplementations.ActionService.Login(LoginRequest request) in C:MarksStuffMarsDoFactoryPatterns In ActionActionServiceServiceImplementationsActionService.cs:line 81\r\n       at SyncInvokeLogin(Object , Object[] , Object[] )\r\n       at System.ServiceModel.Dispatcher.SyncMethodInvoker.Invoke(Object instance, Object[] inputs, Object[]\u0026 outputs)\r\n       at System.ServiceModel.Dispatcher.DispatchOperationRuntime.InvokeBegin(MessageRpc\u0026 rpc)\r\n  InnerException: \r\n\r\nAs described, I installed SQL Server Express.\r\nDoes anyone know what the problem might be?\r\nDo I need to change my windows firewall?\r\nThanx,\r\nMark\r\nPS - I also get an exception \u0027System.Data.EntityException was unhandled by user code\u0027 when doing a search on the website. Again, I haven\u0027t yet \u0027logged in\u0027.",
  "answers": [
    {
      "ansID": 1658,
      "ans": "Hello Mark:\r\n\r\nI am sorry for the trouble.\r\n\r\nI believe the exception shows what the issue is. It states: \r\n\r\n  \u0027 ASPNETDB.MDF cannot be opened because it is version 655. This server supports version 611 and earlier. \r\n  A downgrade path is not supported. \u0027\r\n\r\nBasically, this means you have an old version of SQL Express installed. And it does not know how to deal with a more recent data file format.\r\n\r\nI suggest you uninstall SQL Express from your machine and re-install a more recent SQL Express version.\r\nThat should do the trick.\r\n\r\nHope this helps.\r\nDan"
    },
    {
      "ansID": 1659,
      "ans": "Install SQL Express 2008. First uninstall the previous version or you will have to do some configuration in the project to look at whatever InstanceID you give the 2008 install."
    },
    {
      "ansID": 1660,
      "ans": "Um, sorry, that\u0027s not the answer.  I de-installed SQL Express 2008, and also the 2005 Version which I didn\u0027t realize was there. Then I re-installed, fresh, SQL Express 2008.  For testing, I turned off the Windows Firewall.The exception, which occurs on exactly the same line as stated above (L. 81) is:\r\n\r\nSystem.Data.SqlClient.SqlException was unhandled by user code\r\n  Message\u003dFailed to generate a user instance of SQL Server due to a failure in starting the process for the user instance. The connection will be closed.\r\n  Source\u003d.Net SqlClient Data Provider\r\n  ErrorCode\u003d-2146232060\r\n  Class\u003d14\r\n  LineNumber\u003d65536\r\n  Number\u003d15372\r\n  Procedure\u003d \u0027 \u0027\r\n  Server\u003d.SQLEXPRESS\r\n  State\u003d1\r\n  StackTrace:\r\n\r\nRegards, Mark\r\n"
    },
    {
      "ansID": 1661,
      "ans": "Check your web.config in the Hosting Layer (default should still be  \u0027\u003cadd key\u003d \u0027ConnectionStringName \u0027 value\u003d \u0027EntityFramework.SqlExpress \u0027/\u003e \u0027. Also make sure the version of Sql Express 2008 still has the InstanceID of SQLEXPRESS. I doubt it does since you already had SqlExpress 2005 and that is probabaly most definitely has the InstanceID of SqlExpress. Find out the instanceID and once you do you have to go to within Visual Studio - Tools, Options and once options comes up drop down Database Tools then go to Data Connections and change  \u0027Sql Server Instance Name (blank for default): \u0027 That should do it.I had the exact same issue. Once you do that double click on the .mdf files just to make sure you can open them and then start the solution. Worked for me. \r\n\r\nThanks"
    },
    {
      "ansID": 1662,
      "ans": "Hmm, this is turning into a real problem.\r\n- According to the  \u0027Sql Server Configuration Manager \u0027, SQL Server Services tab, I see  \u0027SQL Server (SQLEXPRESS).  So I assume that that is my InstanceID.  IS THIS THE TOOL, AND INSTANCE-ID, THAT YOU MEAN???\r\n- In Tools -\u003e Options -\u003e Database Tools -\u003e Data Connections I see  \u0027SQLEXPRESS \u0027\r\n- In the  \u0027web.config \u0027 file, I see the key  \u0027\u003cadd key\u003d \u0027ConnectionStringName \u0027 value\u003d \u0027EntityFramework.SqlExpress \u0027/\u003e \u0027 so that meets your spec.\r\n\r\nStill, I get the exception!  I\u0027m really sorry to be a pain in the butt and yes I\u0027m a newbie to your tools but this must somehow work. I humbly ask for more help.  I have googled the issue but nothing really helped.\r\n\r\nRegards,\r\nMark\r\n"
    },
    {
      "ansID": 1665,
      "ans": "Please see the image SQL-Server-Config-Manager, enclosed.  I just hope it\u0027s readable!\r\nRegards,\r\nMark\r\n\r\n\r\n\r\n\r\n"
    },
    {
      "ansID": 1666,
      "ans": "I found the problem:\r\nI had to delete directory\r\nC:Documents and SettingsUSERNAMELocal SettingsApplication DataMicrosoftMicrosoft SQL Server DataSQLEXPRESS.     \r\nRemember to replace USERNAME with your username.\r\n\r\nSee \r\nhttp://blog.laksha.net/2009/02/sql-express-error-failed-to-generate.html\r\n\r\nCheers,\r\nMark\r\n"
    }
  ]
}